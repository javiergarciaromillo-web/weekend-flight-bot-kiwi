<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ subject }}</title>
</head>
<body style="font-family: Arial, Helvetica, sans-serif; background:#ffffff; color:#111; margin:0; padding:24px;">
  <div style="max-width:860px; margin:0 auto;">

    <!-- HEADER -->
    <div style="border:1px solid #e5e7eb; border-radius:10px; padding:18px 18px 8px 18px;">
      <div style="font-size:20px; font-weight:700; margin-bottom:6px;">
        {{ header }}
      </div>

      <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">
        Outbound {{ out_time_from }}–{{ out_time_to }} |
        Inbound {{ in_time_from }}–{{ in_time_to }} |
        {{ weeks }} weeks |
        Direct only |
        EUR
      </div>

      <div style="font-size:12px; color:#6b7280; margin-bottom:14px;">
        Last API refresh: {{ last_updated }} (email sent: {{ run_date }})
      </div>
    </div>

    <!-- WEEKENDS -->
    {% for w in weekends %}
      <div style="margin-top:18px; border:1px solid #e5e7eb; border-radius:10px; padding:16px;">

        <!-- Weekend title -->
        <div style="font-size:16px; font-weight:700;">
          Weekend starting {{ w.week_start }} (→ {{ w.week_end }})
        </div>

        <!-- Best in weekend -->
        <div style="margin-top:8px; padding:10px; border-radius:10px; background:#f9fafb; border:1px solid #eef2f7;">
          <div style="font-size:12px; color:#6b7280;">
            Best in this weekend:
          </div>
          <div style="font-size:18px; font-weight:800; margin-top:2px;">
            {{ w.best_label }}
          </div>
        </div>

        <!-- Routes (AMS↔BCN, RTM↔BCN) -->
        {% for route in w.routes %}
          <div style="margin-top:16px; font-size:14px; font-weight:700;">
            {{ route.route_label }}
          </div>

          <!-- Patterns -->
          {% for p in route.patterns %}
            <div style="margin-top:10px; border:1px solid #eef2f7; border-radius:10px; padding:12px;">

              <div style="display:flex; justify-content:space-between; flex-wrap:wrap;">
                <div style="font-size:13px; font-weight:700;">
                  {{ p.pattern_label }}
                  <span style="font-size:12px; color:#6b7280;">
                    ({{ p.outbound_date }} → {{ p.inbound_date }})
                  </span>
                </div>

                {% if p.best %}
                  <div style="font-size:14px; font-weight:800;">
                    €{{ "%.2f"|format(p.best.price_eur) }}
                  </div>
                {% endif %}
              </div>

              {% if p.best %}

                <!-- Best offer -->
                <div style="margin-top:8px; font-size:12px;">
                  1) €{{ "%.2f"|format(p.best.price_eur) }}
                  {{ p.best.flight_out }}
                  {{ p.best.depart_out }}–{{ p.best.arrive_out }}
                  |
                  {{ p.best.flight_in }}
                  {{ p.best.depart_in }}–{{ p.best.arrive_in }}
                </div>

                <!-- Delta -->
                {% if p.delta is not none %}
                  <div style="margin-top:6px; font-size:12px;">
                    {% if p.delta > 0 %}
                      <span style="color:#b91c1c; font-weight:700;">
                        ↑ {{ "%.2f"|format(p.delta) }}
                      </span>
                    {% elif p.delta < 0 %}
                      <span style="color:#047857; font-weight:700;">
                        ↓ {{ "%.2f"|format(-p.delta) }}
                      </span>
                    {% else %}
                      <span style="color:#6b7280;">
                        = 0.00
                      </span>
                    {% endif %}
                    <span style="color:#6b7280;"> vs previous run</span>
                  </div>
                {% endif %}

                <!-- Additional offers -->
                {% if p.top and (p.top|length) > 1 %}
                  <div style="margin-top:8px; font-size:12px; color:#374151;">
                    {% for o in p.top[1:] %}
                      {{ loop.index + 1 }})
                      €{{ "%.2f"|format(o.price_eur) }}
                      {{ o.flight_out }}
                      {{ o.depart_out }}–{{ o.arrive_out }}
                      |
                      {{ o.flight_in }}
                      {{ o.depart_in }}–{{ o.arrive_in }}
                      <br/>
                    {% endfor %}
                  </div>
                {% endif %}

              {% else %}
                <div style="margin-top:8px; font-size:12px; color:#6b7280;">
                  No direct offers matching the selected time windows.
                </div>
              {% endif %}

            </div>
          {% endfor %}
        {% endfor %}

      </div>
    {% endfor %}

  </div>
</body>
</html>
